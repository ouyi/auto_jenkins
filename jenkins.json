{
    "variables": {
        "ansible_host": "default",
        "ansible_connection": "docker"
    },
    "builders": [
        {
            "type": "docker",
            "image": "jenkins/jenkins:lts-alpine",
            "commit": "true",
            "run_command": [ "-u", "root", "--name", "{{user `ansible_host`}}", "-d", "-i", "-t", "{{.Image}}", "/bin/sh" ],
            "changes": [
                "ENV JAVA_OPTS '-Djenkins.install.runSetupWizard=false'",
                "USER 'jenkins'",
                "ENTRYPOINT [\"/sbin/tini\", \"--\", \"/usr/local/bin/jenkins.sh\"]"
            ]
        }
    ],
    "provisioners": [
        {
            "type": "shell",
            "inline": ["apk --update add python && rm -rf /var/cache/apk/*"]
        },
        {
            "type": "ansible",
            "playbook_file": "./ansible/initial_setup.yml",
            "user": "root",
            "extra_arguments": [ "--extra-vars", "ansible_host={{user `ansible_host`}} ansible_connection={{user `ansible_connection`}} @ansible/extra-vars.json" ]
        }
    ],
    "post-processors": [
        {
            "type": "docker-tag",
            "repository": "ouyi/test",
            "tag": "0.0.2"
        }
    ]
}
